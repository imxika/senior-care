# ğŸ—„ï¸ Supabase ì•„í‚¤í…ì²˜ ë¬¸ì„œ

**í”„ë¡œì íŠ¸**: Senior Care MVP
**ì‘ì„±ì¼**: 2025-10-02
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-07 (Day 7)
**ë²„ì „**: 2.0
**ìƒíƒœ**: âœ… ìš´ì˜ ì¤‘

---

## ğŸ“‹ ëª©ì°¨

1. [ì•„í‚¤í…ì²˜ ê²°ì • ë°°ê²½](#ì•„í‚¤í…ì²˜-ê²°ì •-ë°°ê²½)
2. [í˜„ì¬ êµ¬ì¡°](#í˜„ì¬-êµ¬ì¡°)
3. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
4. [ì¸ì¦ ì‹œìŠ¤í…œ](#ì¸ì¦-ì‹œìŠ¤í…œ)
5. [ìŠ¤í† ë¦¬ì§€ êµ¬ì¡°](#ìŠ¤í† ë¦¬ì§€-êµ¬ì¡°)
6. [ì‹¤ì‹œê°„ ê¸°ëŠ¥](#ì‹¤ì‹œê°„-ê¸°ëŠ¥)
7. [ë³´ì•ˆ ì •ì±… (RLS)](#ë³´ì•ˆ-ì •ì±…-rls)
8. [í™•ì¥ ê³„íš](#í™•ì¥-ê³„íš)
9. [ìš´ì˜ ê°€ì´ë“œ](#ìš´ì˜-ê°€ì´ë“œ)

---

## ğŸ¯ ì•„í‚¤í…ì²˜ ê²°ì • ë°°ê²½

### ì„ íƒ: ë³„ë„ Supabase í”„ë¡œì íŠ¸ (ë¶„ë¦¬) â­

**ê²°ì • ì´ìœ **:
1. âœ… **ì™„ë²½í•œ ê²©ë¦¬**: ê¸°ì¡´ í”„ë¡œì íŠ¸ì™€ 100% ë¶„ë¦¬
2. âœ… **ì‹¤í—˜ì  MVP**: ì‹¤íŒ¨ ì‹œ ì˜í–¥ ìµœì†Œí™”
3. âœ… **ë…ë¦½ì  í™•ì¥**: ì„±ê³µ ì‹œ ë…ë¦½ì ìœ¼ë¡œ ì„±ì¥ ê°€ëŠ¥
4. âœ… **ë¦¬ìŠ¤í¬ ë¶„ì‚°**: ì¥ì•  ê²©ë¦¬
5. âœ… **ê°„ë‹¨í•œ êµ¬ì¡°**: RLS ë³µì¡ë„ ë‚®ìŒ

**ëŒ€ì•ˆ (í†µí•© í”„ë¡œì íŠ¸)**:
- ë¹„ìš© ì ˆê°ì€ ê°€ëŠ¥í•˜ì§€ë§Œ RLS ë³µì¡ë„ ì¦ê°€
- ë°ì´í„° ê²©ë¦¬ ì–´ë ¤ì›€
- í™•ì¥ì„± í•œê³„
- ì¥ì•  ì‹œ ì „ì²´ ì˜í–¥

### ë¹„ìš© ë¶„ì„

```
í˜„ì¬ (ë¬´ë£Œ í”Œëœ):
- Senior Care Supabase: $0/ì›”
- 500MB ë°ì´í„°ë² ì´ìŠ¤
- 1GB íŒŒì¼ ìŠ¤í† ë¦¬ì§€
- ë¬´ì œí•œ API ìš”ì²­

ì„±ì¥ í›„ (Pro í”Œëœ):
- Senior Care Supabase: $25/ì›”
- 8GB ë°ì´í„°ë² ì´ìŠ¤
- 100GB íŒŒì¼ ìŠ¤í† ë¦¬ì§€
- ë¬´ì œí•œ API ìš”ì²­

â†’ ë§¤ì¶œ ë°œìƒ ì‹œ ì¶©ë¶„íˆ ê°ë‹¹ ê°€ëŠ¥í•œ ë¹„ìš©
```

---

## ğŸ—ï¸ í˜„ì¬ êµ¬ì¡°

### Supabase í”„ë¡œì íŠ¸ ì •ë³´

```yaml
í”„ë¡œì íŠ¸ëª…: senior-care-mvp
ì§€ì—­: Seoul (ap-northeast-2)
í”Œëœ: Free Tier
Database: PostgreSQL 15
API URL: https://xxx.supabase.co
```

### ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Senior Care Supabase Project        â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Authentication                  â”‚ â”‚
â”‚  â”‚  - Email/Password                       â”‚ â”‚
â”‚  â”‚  - ì¹´ì¹´ì˜¤/ë„¤ì´ë²„/êµ¬ê¸€ OAuth (ì¤€ë¹„)      â”‚ â”‚
â”‚  â”‚  - ì „í™”ë²ˆí˜¸ ì¸ì¦ (ì¤€ë¹„)                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Database (PostgreSQL)           â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚  Core Tables:                            â”‚ â”‚
â”‚  â”‚  â”œâ”€ profiles (ì‚¬ìš©ì ê¸°ë³¸)              â”‚ â”‚
â”‚  â”‚  â”œâ”€ customers (ê³ ê° ìƒì„¸)               â”‚ â”‚
â”‚  â”‚  â”œâ”€ trainers (íŠ¸ë ˆì´ë„ˆ ìƒì„¸)            â”‚ â”‚
â”‚  â”‚  â””â”€ bookings (ì˜ˆì•½)                     â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚  Feature Tables:                         â”‚ â”‚
â”‚  â”‚  â”œâ”€ notifications (ì•Œë¦¼)                â”‚ â”‚
â”‚  â”‚  â”œâ”€ trainer_availability (ê°€ìš©ì‹œê°„)     â”‚ â”‚
â”‚  â”‚  â”œâ”€ favorites (ì¦ê²¨ì°¾ê¸°)                â”‚ â”‚
â”‚  â”‚  â””â”€ reviews (ë¦¬ë·° - ì˜ˆì •)              â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚  Settings Tables:                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ notification_settings (ì•Œë¦¼ì„¤ì •)    â”‚ â”‚
â”‚  â”‚  â””â”€ trainer_billing_info (ê²°ì œì •ë³´)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Storage (Supabase Storage)      â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚  Buckets:                                â”‚ â”‚
â”‚  â”‚  â”œâ”€ profiles (í”„ë¡œí•„ ì‚¬ì§„)              â”‚ â”‚
â”‚  â”‚  â”œâ”€ certificates (ìê²©ì¦ - ì˜ˆì •)        â”‚ â”‚
â”‚  â”‚  â””â”€ center-photos (ì„¼í„° ì‚¬ì§„ - ì˜ˆì •)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Realtime (ì‹¤ì‹œê°„ ê¸°ëŠ¥)          â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ notifications (ì•Œë¦¼)                â”‚ â”‚
â”‚  â”‚  â””â”€ bookings (ì˜ˆì•½ ìƒíƒœ - ì˜ˆì •)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Functions & Triggers            â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ handle_new_user() (ìë™ í”„ë¡œí•„)    â”‚ â”‚
â”‚  â”‚  â””â”€ auto_approve_pending_bookings()     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### í•µì‹¬ ì„¤ê³„ ì›ì¹™

1. **3ë‹¨ê³„ ì‚¬ìš©ì ëª¨ë¸**:
   ```
   auth.users (ì¸ì¦)
   â†’ profiles (ê³µí†µ ì •ë³´)
     â†’ customers / trainers (ì—­í• ë³„ ìƒì„¸)
   ```

2. **ì™„ë²½í•œ ë°ì´í„° ê²©ë¦¬**:
   - RLS (Row Level Security) ì •ì±…ìœ¼ë¡œ ê¶Œí•œ ê´€ë¦¬
   - ê³ ê°/íŠ¸ë ˆì´ë„ˆ/ê´€ë¦¬ì ê¶Œí•œ ë¶„ë¦¬
   - ê° ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë°ì´í„°ë§Œ ì ‘ê·¼

3. **í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°**:
   - ì˜ˆì•½ íƒ€ì… (ì§€ì •/ì¶”ì²œ)
   - íŠ¸ë ˆì´ë„ˆ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜
   - ì•Œë¦¼ ì‹œìŠ¤í…œ
   - ë¦¬ë·° ì‹œìŠ¤í…œ (ì˜ˆì •)

### í…Œì´ë¸” ê´€ê³„ë„

```sql
auth.users (Supabase Auth)
    â†“ id
profiles (ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´)
    â†“ id (= auth.users.id)
    â”œâ”€â†’ customers (ê³ ê° ìƒì„¸)
    â”‚       â†“ id
    â”‚   bookings (ì˜ˆì•½)
    â”‚       â†‘ customer_id
    â”‚       â†“ trainer_id
    â””â”€â†’ trainers (íŠ¸ë ˆì´ë„ˆ ìƒì„¸)
            â†“ id
        bookings (ì˜ˆì•½)
        trainer_availability (ê°€ìš©ì‹œê°„)
        trainer_billing_info (ê²°ì œì •ë³´)
```

### ì£¼ìš” í…Œì´ë¸” (Day 7 ê¸°ì¤€)

#### 1. profiles (ì‚¬ìš©ì ê³µí†µ)
```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT NOT NULL,
  full_name TEXT,
  phone TEXT,
  avatar_url TEXT,
  birth_date DATE,  -- Day 6 ì¶”ê°€
  user_type TEXT NOT NULL DEFAULT 'customer',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**íŠ¹ì§•**:
- auth.users.idì™€ ë™ì¼í•œ id ì‚¬ìš©
- user_typeìœ¼ë¡œ ì—­í•  êµ¬ë¶„ (customer/trainer/admin)
- ëª¨ë“  ì‚¬ìš©ì ê³µí†µ ì •ë³´ ì €ì¥

#### 2. customers (ê³ ê° ìƒì„¸)
```sql
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  profile_id UUID UNIQUE REFERENCES profiles(id),
  age INTEGER,
  gender TEXT,
  address TEXT,
  address_detail TEXT,
  emergency_contact TEXT,
  emergency_phone TEXT,
  guardian_name TEXT,  -- Day 6 ì¶”ê°€
  guardian_phone TEXT,  -- Day 6 ì¶”ê°€
  guardian_relationship TEXT,  -- Day 6 ì¶”ê°€
  medical_conditions TEXT[],
  mobility_level TEXT,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**íŠ¹ì§•**:
- profile_idì— UNIQUE ì œì•½
- í•œ í”„ë¡œí•„ë‹¹ í•˜ë‚˜ì˜ customer ë ˆì½”ë“œ
- ë³´í˜¸ì ì •ë³´ ì¶”ê°€ (Day 6)

#### 3. trainers (íŠ¸ë ˆì´ë„ˆ ìƒì„¸)
```sql
CREATE TABLE trainers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  profile_id UUID UNIQUE REFERENCES profiles(id),
  bio TEXT,
  specialties TEXT[],
  certifications TEXT[],
  years_experience INTEGER,
  rating DECIMAL(3,2) DEFAULT 0,
  total_reviews INTEGER DEFAULT 0,
  hourly_rate DECIMAL(10,2),
  home_visit_available BOOLEAN DEFAULT false,
  center_visit_available BOOLEAN DEFAULT false,
  center_address TEXT,
  center_name TEXT,
  service_areas TEXT[],
  is_verified BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  max_group_size INTEGER DEFAULT 1,  -- Day 7 ì¶”ê°€
  bank_name TEXT,  -- Day 7 ì¶”ê°€ (ê²°ì œ ì •ë³´)
  account_number TEXT,  -- Day 7 ì¶”ê°€
  account_holder TEXT,  -- Day 7 ì¶”ê°€
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**íŠ¹ì§•**:
- profile_idì— UNIQUE ì œì•½
- í‰ì /ë¦¬ë·° ì‹œìŠ¤í…œ ì¤€ë¹„
- ê·¸ë£¹ ìˆ˜ì—… ì§€ì› (max_group_size)
- ê²°ì œ ì •ë³´ ë‚´ì¥ (Day 7)

#### 4. bookings (ì˜ˆì•½)
```sql
CREATE TABLE bookings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  customer_id UUID REFERENCES customers(id),
  trainer_id UUID REFERENCES trainers(id),  -- ì¶”ì²œì˜ˆì•½ ì‹œ NULL
  booking_type booking_type_enum DEFAULT 'direct',  -- direct/recommended
  price_multiplier DECIMAL(3,2) DEFAULT 1.0,
  service_type TEXT NOT NULL,  -- home_visit/center_visit
  group_size INTEGER DEFAULT 1,
  booking_date DATE NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  duration_minutes INTEGER,
  price_per_person DECIMAL(10,2),
  total_price DECIMAL(10,2),
  customer_notes TEXT,
  trainer_notes TEXT,
  status booking_status_enum DEFAULT 'pending',
  admin_matched_at TIMESTAMPTZ,  -- ì¶”ì²œì˜ˆì•½ ë§¤ì¹­ ì‹œê°
  admin_matched_by UUID REFERENCES profiles(id),
  rejection_reason rejection_reason_enum,  -- Day 4 ì¶”ê°€
  rejection_note TEXT,  -- Day 4 ì¶”ê°€
  cancellation_reason TEXT,
  cancelled_by UUID REFERENCES profiles(id),
  cancelled_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**íŠ¹ì§•**:
- ì˜ˆì•½ íƒ€ì…: ì§€ì •(direct) / ì¶”ì²œ(recommended)
- ì¶”ì²œ ì˜ˆì•½ì€ ì´ˆê¸°ì— trainer_id NULL, ê´€ë¦¬ì ë§¤ì¹­ í›„ ì„¤ì •
- ê±°ì ˆ ì‚¬ìœ  ì¶”ì  (Day 4)
- ê°€ê²© ë°°ìˆ˜ (ì§€ì •: 1.3, ì¶”ì²œ: 1.0)

#### 5. notifications (ì•Œë¦¼)
```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  type notification_type_enum NOT NULL,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  link TEXT,
  is_read BOOLEAN DEFAULT false,
  read_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**íŠ¹ì§•**:
- Supabase Realtime í™œì„±í™”
- ì‹¤ì‹œê°„ ì•Œë¦¼ ì—…ë°ì´íŠ¸
- ì•Œë¦¼ í´ë¦­ ì‹œ ê´€ë ¨ í˜ì´ì§€ë¡œ ì´ë™

#### 6. trainer_availability (ê°€ìš© ì‹œê°„)
```sql
CREATE TABLE trainer_availability (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  trainer_id UUID REFERENCES trainers(id),
  day_of_week INTEGER CHECK (day_of_week >= 0 AND day_of_week <= 6),
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**íŠ¹ì§•**:
- ìš”ì¼ë³„ ê°€ìš© ì‹œê°„ ì„¤ì •
- íŠ¸ë ˆì´ë„ˆë³„ ë‹¤ì¤‘ ì‹œê°„ ìŠ¬ë¡¯ ì§€ì›
- Day 4 êµ¬í˜„

#### 7. favorites (ì¦ê²¨ì°¾ê¸°)
```sql
CREATE TABLE favorites (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  customer_id UUID REFERENCES customers(id),
  trainer_id UUID REFERENCES trainers(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(customer_id, trainer_id)
);
```

**íŠ¹ì§•**:
- ê³ ê°ë³„ ì¦ê²¨ì°¾ê¸° íŠ¸ë ˆì´ë„ˆ
- ì¤‘ë³µ ë°©ì§€ (UNIQUE ì œì•½)
- Day 6 êµ¬í˜„

#### 8. notification_settings (ì•Œë¦¼ ì„¤ì •)
```sql
CREATE TABLE notification_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  trainer_id UUID UNIQUE REFERENCES trainers(id),
  booking_notifications BOOLEAN DEFAULT true,
  reminder_notifications BOOLEAN DEFAULT true,
  marketing_notifications BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**íŠ¹ì§•**:
- íŠ¸ë ˆì´ë„ˆë³„ ì•Œë¦¼ ì„¤ì •
- ì¹´í…Œê³ ë¦¬ë³„ ON/OFF
- Day 7 êµ¬í˜„

### Enum íƒ€ì…

```sql
-- ì‚¬ìš©ì íƒ€ì…
CREATE TYPE user_type AS ENUM ('customer', 'trainer', 'admin');

-- ì˜ˆì•½ íƒ€ì…
CREATE TYPE booking_type_enum AS ENUM ('direct', 'recommended');

-- ì˜ˆì•½ ìƒíƒœ
CREATE TYPE booking_status_enum AS ENUM (
  'pending',      -- ìŠ¹ì¸ ëŒ€ê¸°
  'confirmed',    -- í™•ì •
  'in_progress',  -- ì§„í–‰ ì¤‘
  'completed',    -- ì™„ë£Œ
  'cancelled',    -- ì·¨ì†Œ
  'no_show'       -- ë…¸ì‡¼
);

-- ê±°ì ˆ ì‚¬ìœ 
CREATE TYPE rejection_reason_enum AS ENUM (
  'personal_emergency',  -- ê°œì¸ ì‚¬ì •
  'health_issue',        -- ê±´ê°• ë¬¸ì œ
  'schedule_conflict',   -- ì¼ì • ì¶©ëŒ
  'distance_too_far',    -- ê±°ë¦¬ ë¬¸ì œ
  'customer_requirements', -- ê³ ê° ìš”êµ¬ì‚¬í•­ ë¶ˆì¼ì¹˜
  'other'                -- ê¸°íƒ€
);

-- ì•Œë¦¼ íƒ€ì…
CREATE TYPE notification_type_enum AS ENUM (
  'booking_confirmed',
  'booking_cancelled',
  'booking_completed',
  'booking_pending',
  'booking_rejected',
  'booking_matched',
  'system'
);
```

---

## ğŸ” ì¸ì¦ ì‹œìŠ¤í…œ

### ì¸ì¦ í”Œë¡œìš°

```typescript
// 1. íšŒì›ê°€ì…
const { data, error } = await supabase.auth.signUp({
  email: 'user@example.com',
  password: 'password123',
  options: {
    data: {
      full_name: 'í™ê¸¸ë™',
      user_type: 'customer'  // or 'trainer'
    }
  }
})

// 2. ìë™ í”„ë¡œí•„ ìƒì„± (Trigger)
// - profiles í…Œì´ë¸”ì— ë ˆì½”ë“œ ìƒì„±
// - user_typeì— ë”°ë¼ customers/trainers í…Œì´ë¸”ì— ë ˆì½”ë“œ ìƒì„±

// 3. ë¡œê·¸ì¸
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'password123'
})

// 4. ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
const { data: { user } } = await supabase.auth.getUser()
// user.id = profiles.id
```

### OAuth ì¤€ë¹„ (ì˜ˆì •)

```yaml
ì¹´ì¹´ì˜¤:
  - Client ID: ì„¤ì • í•„ìš”
  - Redirect URL: /auth/callback

ë„¤ì´ë²„:
  - Client ID: ì„¤ì • í•„ìš”
  - Redirect URL: /auth/callback

êµ¬ê¸€:
  - Client ID: ì„¤ì • í•„ìš”
  - Redirect URL: /auth/callback
```

---

## ğŸ“¦ ìŠ¤í† ë¦¬ì§€ êµ¬ì¡°

### Bucket: profiles (Public)

```yaml
ì´ë¦„: profiles
ê¶Œí•œ: Public
ìš©ë„: ì‚¬ìš©ì í”„ë¡œí•„ ì‚¬ì§„
íŒŒì¼ëª… íŒ¨í„´: {userId}.{ext}
ìµœëŒ€ í¬ê¸°: 5MB
í—ˆìš© íƒ€ì…: image/jpeg, image/png, image/gif, image/webp
```

**RLS ì •ì±…**:
```sql
-- ëª¨ë“  ì‚¬ìš©ìê°€ í”„ë¡œí•„ ì‚¬ì§„ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Anyone can view avatars"
ON storage.objects FOR SELECT
USING (bucket_id = 'profiles');

-- ë³¸ì¸ë§Œ ì—…ë¡œë“œ/ì—…ë°ì´íŠ¸/ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Users can upload own avatar"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'profiles'
  AND auth.uid()::text = (storage.foldername(name))[1]
);
```

**ì—…ë¡œë“œ ì˜ˆì‹œ**:
```typescript
const file = event.target.files[0]
const fileExt = file.name.split('.').pop()
const fileName = `${userId}.${fileExt}`

const { data, error } = await supabase.storage
  .from('profiles')
  .upload(fileName, file, { upsert: true })
```

### Bucket: certificates (Private - ì˜ˆì •)

```yaml
ì´ë¦„: certificates
ê¶Œí•œ: Private
ìš©ë„: íŠ¸ë ˆì´ë„ˆ ìê²©ì¦ íŒŒì¼
ìµœëŒ€ í¬ê¸°: 10MB
í—ˆìš© íƒ€ì…: image/*, application/pdf
```

---

## âš¡ ì‹¤ì‹œê°„ ê¸°ëŠ¥

### Realtime êµ¬ë…

#### 1. ì•Œë¦¼ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸

```typescript
const channel = supabase
  .channel('notifications')
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications',
      filter: `user_id=eq.${userId}`
    },
    (payload) => {
      console.log('ìƒˆ ì•Œë¦¼:', payload.new)
      // UI ì—…ë°ì´íŠ¸
    }
  )
  .subscribe()
```

**í™œìš©**:
- ì‹¤ì‹œê°„ ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
- ì‚¬ìš´ë“œ ì•Œë¦¼ ì¬ìƒ
- ë°°ì§€ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸

#### 2. ì˜ˆì•½ ìƒíƒœ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì˜ˆì •)

```typescript
const channel = supabase
  .channel('bookings')
  .on(
    'postgres_changes',
    {
      event: 'UPDATE',
      schema: 'public',
      table: 'bookings',
      filter: `id=eq.${bookingId}`
    },
    (payload) => {
      console.log('ì˜ˆì•½ ìƒíƒœ ë³€ê²½:', payload.new.status)
      // ì˜ˆì•½ ìƒíƒœ íŠ¸ë˜ì»¤ ì—…ë°ì´íŠ¸
    }
  )
  .subscribe()
```

---

## ğŸ›¡ï¸ ë³´ì•ˆ ì •ì±… (RLS)

### RLS í™œì„±í™” í˜„í™©

```sql
-- ëª¨ë“  í…Œì´ë¸”ì— RLS í™œì„±í™”
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE trainers ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE trainer_availability ENABLE ROW LEVEL SECURITY;
ALTER TABLE favorites ENABLE ROW LEVEL SECURITY;
```

### ì£¼ìš” RLS ì •ì±…

#### profiles
```sql
-- ë³¸ì¸ í”„ë¡œí•„ë§Œ ì¡°íšŒ/ìˆ˜ì •
CREATE POLICY "Users can view own profile"
ON profiles FOR SELECT
USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
ON profiles FOR UPDATE
USING (auth.uid() = id);
```

#### bookings
```sql
-- ê³ ê°: ë³¸ì¸ ì˜ˆì•½ë§Œ ì¡°íšŒ
CREATE POLICY "Customers can view own bookings"
ON bookings FOR SELECT
USING (
  customer_id IN (
    SELECT id FROM customers WHERE profile_id = auth.uid()
  )
);

-- íŠ¸ë ˆì´ë„ˆ: ë³¸ì¸ ì˜ˆì•½ë§Œ ì¡°íšŒ
CREATE POLICY "Trainers can view own bookings"
ON bookings FOR SELECT
USING (
  trainer_id IN (
    SELECT id FROM trainers WHERE profile_id = auth.uid()
  )
);

-- ê´€ë¦¬ì: ëª¨ë“  ì˜ˆì•½ ì¡°íšŒ
CREATE POLICY "Admins can view all bookings"
ON bookings FOR ALL
USING (
  EXISTS (
    SELECT 1 FROM profiles
    WHERE id = auth.uid() AND user_type = 'admin'
  )
);
```

#### íŠ¹ë³„ ì •ì±…: trainers í…Œì´ë¸”

```sql
-- í™œì„± íŠ¸ë ˆì´ë„ˆëŠ” ëª¨ë‘ê°€ ì¡°íšŒ ê°€ëŠ¥ (ê³µê°œ ëª©ë¡)
CREATE POLICY "Anyone can view active trainers"
ON trainers FOR SELECT
USING (is_active = true);

-- íŠ¸ë ˆì´ë„ˆ ë³¸ì¸ë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Trainers can update own data"
ON trainers FOR UPDATE
USING (profile_id = auth.uid());
```

**ì´ìœ **: íŠ¸ë ˆì´ë„ˆ ëª©ë¡ í˜ì´ì§€ì—ì„œ ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìë„ ì¡°íšŒ ê°€ëŠ¥í•´ì•¼ í•¨

---

## ğŸ”§ Functions & Triggers

### 1. handle_new_user() (ìë™ í”„ë¡œí•„ ìƒì„±)

**íŠ¸ë¦¬ê±°**: auth.users INSERT ì‹œ ìë™ ì‹¤í–‰

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- 1. profiles ìƒì„±
  INSERT INTO public.profiles (id, email, full_name, user_type)
  VALUES (
    new.id,
    new.email,
    COALESCE(new.raw_user_meta_data->>'full_name', ''),
    COALESCE(new.raw_user_meta_data->>'user_type', 'customer')
  );

  -- 2. user_typeì— ë”°ë¼ customers/trainers ìƒì„±
  IF COALESCE(new.raw_user_meta_data->>'user_type', 'customer') = 'customer' THEN
    INSERT INTO public.customers (profile_id) VALUES (new.id);
  ELSIF COALESCE(new.raw_user_meta_data->>'user_type', 'customer') = 'trainer' THEN
    INSERT INTO public.trainers (profile_id) VALUES (new.id);
  END IF;

  RETURN new;
END;
$$;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();
```

**ê²°ê³¼**: íšŒì›ê°€ì… ì‹œ profiles + customers/trainers ìë™ ìƒì„±

### 2. auto_approve_pending_bookings() (ìë™ ìŠ¹ì¸)

**ìš©ë„**: íŠ¸ë ˆì´ë„ˆ ë§¤ì¹­ í›„ 1ì‹œê°„ ê²½ê³¼í•œ ì˜ˆì•½ ìë™ ìŠ¹ì¸

```sql
CREATE OR REPLACE FUNCTION auto_approve_pending_bookings()
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  UPDATE bookings
  SET status = 'confirmed'
  WHERE status = 'pending'
    AND booking_type = 'recommended'
    AND trainer_id IS NOT NULL
    AND admin_matched_at IS NOT NULL
    AND admin_matched_at < NOW() - INTERVAL '1 hour';
END;
$$;
```

**ì‹¤í–‰**: Vercel Cron (10ë¶„ë§ˆë‹¤) ë˜ëŠ” Supabase pg_cron

---

## ğŸš€ í™•ì¥ ê³„íš

### Phase 1: MVP ì™„ì„± (í˜„ì¬ ì§„í–‰ ì¤‘)

- [x] ê¸°ë³¸ ì¸ì¦ ì‹œìŠ¤í…œ
- [x] ì˜ˆì•½ ì‹œìŠ¤í…œ (ì§€ì •/ì¶”ì²œ)
- [x] íŠ¸ë ˆì´ë„ˆ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜
- [x] ì‹¤ì‹œê°„ ì•Œë¦¼
- [x] í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ
- [x] ì¦ê²¨ì°¾ê¸° ê¸°ëŠ¥
- [ ] ë¦¬ë·° ì‹œìŠ¤í…œ
- [ ] ê²°ì œ ì‹œìŠ¤í…œ

### Phase 2: ê³ ê¸‰ ê¸°ëŠ¥

```sql
-- ë¦¬ë·° í…Œì´ë¸” (ì˜ˆì •)
CREATE TABLE reviews (
  id UUID PRIMARY KEY,
  booking_id UUID REFERENCES bookings(id),
  customer_id UUID REFERENCES customers(id),
  trainer_id UUID REFERENCES trainers(id),
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ê²°ì œ ë‚´ì—­ (ì˜ˆì •)
CREATE TABLE payments (
  id UUID PRIMARY KEY,
  booking_id UUID REFERENCES bookings(id),
  amount DECIMAL(10,2),
  status TEXT,  -- pending/completed/failed/refunded
  payment_method TEXT,
  transaction_id TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Phase 3: ì‹œë‹ˆì–´ ì„œë¹„ìŠ¤ í™•ì¥

```sql
-- Organization êµ¬ì¡° ë„ì… (ë¯¸ë˜)
CREATE TABLE organizations (
  id UUID PRIMARY KEY,
  service_type TEXT,  -- 'rehab', 'food-delivery', 'shopping'
  name TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- í•˜ë‚˜ì˜ Supabaseë¡œ ì—¬ëŸ¬ ì‹œë‹ˆì–´ ì„œë¹„ìŠ¤ ê´€ë¦¬
```

---

## ğŸ“Š ìš´ì˜ ê°€ì´ë“œ

### ì¼ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] RLS ì •ì±… ìœ„ë°˜ ë¡œê·¸ í™•ì¸
- [ ] Realtime ì—°ê²° ìƒíƒœ í™•ì¸
- [ ] Storage ìš©ëŸ‰ í™•ì¸
- [ ] Database í¬ê¸° ëª¨ë‹ˆí„°ë§

### ì£¼ê°„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ë°±ì—… í™•ì¸
- [ ] ëŠë¦° ì¿¼ë¦¬ ë¶„ì„
- [ ] ì¸ë±ìŠ¤ ì„±ëŠ¥ ì²´í¬
- [ ] ì‚¬ìš©ì ì¦ê°€ ì¶”ì´

### ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…

```bash
# Supabase CLI ì‚¬ìš©
supabase db dump -f backup.sql

# ë³µì›
supabase db reset
psql -h db.xxx.supabase.co -U postgres -d postgres -f backup.sql
```

### ì„±ëŠ¥ ìµœì í™”

```sql
-- ìì£¼ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬ ì¸ë±ìŠ¤
CREATE INDEX idx_bookings_customer ON bookings(customer_id);
CREATE INDEX idx_bookings_trainer ON bookings(trainer_id);
CREATE INDEX idx_bookings_date ON bookings(booking_date);
CREATE INDEX idx_bookings_status ON bookings(status);
CREATE INDEX idx_notifications_user ON notifications(user_id, is_read);
```

### ëª¨ë‹ˆí„°ë§ ì¿¼ë¦¬

```sql
-- í…Œì´ë¸”ë³„ ë ˆì½”ë“œ ìˆ˜
SELECT
  schemaname,
  tablename,
  n_live_tup as row_count
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC;

-- ëŠë¦° ì¿¼ë¦¬ ì°¾ê¸°
SELECT
  query,
  mean_exec_time,
  calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

---

## ğŸ“ ë³€ê²½ ì´ë ¥

### Day 7 (2025-10-07)
- âœ… `trainers.max_group_size` ì¶”ê°€ (ê·¸ë£¹ ìˆ˜ì—… ì§€ì›)
- âœ… `trainers.bank_name`, `account_number`, `account_holder` ì¶”ê°€
- âœ… `notification_settings` í…Œì´ë¸” ìƒì„±
- âœ… íŠ¸ë ˆì´ë„ˆ ì„¤ì • í˜ì´ì§€ ì™„ì„±

### Day 6 (2025-10-07)
- âœ… `profiles.birth_date` ì¶”ê°€
- âœ… `customers.guardian_*` í•„ë“œ ì¶”ê°€ (ë³´í˜¸ì ì •ë³´)
- âœ… `favorites` í…Œì´ë¸” ìƒì„±
- âœ… `profiles` Storage bucket ìƒì„± ë° RLS ì„¤ì •

### Day 5 (2025-10-06)
- âœ… `auto_approve_pending_bookings()` í•¨ìˆ˜ ìƒì„±
- âœ… Vercel Cron ìë™ ìŠ¹ì¸ ì‹œìŠ¤í…œ

### Day 4 (2025-10-06)
- âœ… `bookings.rejection_reason`, `rejection_note` ì¶”ê°€
- âœ… `trainer_availability` í…Œì´ë¸” ìƒì„±
- âœ… rejection_reason_enum íƒ€ì… ìƒì„±

### Day 3 (2025-10-05)
- âœ… `notifications` í…Œì´ë¸” Realtime í™œì„±í™”
- âœ… ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬í˜„

### Day 2 (2025-10-03)
- âœ… `bookings.booking_type`, `price_multiplier` ì¶”ê°€
- âœ… `bookings.admin_matched_at`, `admin_matched_by` ì¶”ê°€
- âœ… RLS ì •ì±… ì™„ì „ ì¬êµ¬ì¶•
- âœ… Admin RLS ì •ì±… ì¶”ê°€

### Day 1 (2025-10-02)
- âœ… ì´ˆê¸° í…Œì´ë¸” ìƒì„±
- âœ… handle_new_user() íŠ¸ë¦¬ê±° ì„¤ì •
- âœ… ê¸°ë³¸ RLS ì •ì±… ì„¤ì •

---

**ë¬¸ì„œ ê´€ë¦¬ì**: Claude Code
**ìµœì¢… ê²€í† **: 2025-10-07
**ë‹¤ìŒ ì—…ë°ì´íŠ¸ ì˜ˆì •**: ë¦¬ë·° ì‹œìŠ¤í…œ êµ¬í˜„ ì‹œ
